# name: test/sql/adbc_connect.test
# description: test adbc connection functions
# group: [adbc]

# Before we load the extension, this will fail
statement error
SELECT adbc_connect({'driver': 'test'});
----
Catalog Error: Scalar Function with name adbc_connect does not exist!

# Require statement will ensure this test is run with this extension loaded
require adbc_scanner

require-env HAS_ADBC_SQLITE_DRIVER

# Test that adbc_connect requires 'driver' option (STRUCT syntax)
statement error
SELECT adbc_connect({'uri': 'test'});
----
Invalid Input Error: adbc_connect: 'driver' option is required

# Test that adbc_connect requires 'driver' option (MAP syntax - backwards compatibility)
statement error
SELECT adbc_connect(MAP {'uri': 'test'});
----
Invalid Input Error: adbc_connect: 'driver' option is required

# Test disconnect with invalid handle
statement error
SELECT adbc_disconnect(12345);
----
Invalid Input Error: adbc_disconnect: Invalid connection handle: 12345

# Test basic connection with STRUCT syntax
statement ok
SET VARIABLE conn_id = (SELECT adbc_connect({'driver': 'sqlite', 'uri': ':memory:'}));

# Test basic connection with MAP syntax (backwards compatibility)
statement ok
SET VARIABLE map_conn = (SELECT adbc_connect(MAP {'driver': 'sqlite', 'uri': ':memory:'}));

# Test disconnect
query I
SELECT adbc_disconnect(getvariable('conn_id')::BIGINT);
----
true

query I
SELECT adbc_disconnect(getvariable('map_conn')::BIGINT);
----
true

# Test that connection is invalid after disconnect
statement error
SELECT * FROM adbc_scan(getvariable('conn_id')::BIGINT, 'SELECT 1');
----
Invalid Input Error: adbc_scan: Invalid connection handle
